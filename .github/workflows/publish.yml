name: Publish ðŸš€

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*" # tag pattern on pub.dev: 'v{{version}}'

jobs:
  version:
    name: Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Extract the version from CMakeLists.txt
      - run: echo "CMAKE_VER=$(grep -oP 'VERSION\s\K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt)" >> $GITHUB_ENV
      # Extract the version from pubspec.yaml
      - run: echo "PUB_VER=$(grep -oP 'version:\s\K[0-9]+\.[0-9]+\.[0-9]+' dart/pubspec.yaml)" >> $GITHUB_ENV
      # Compare the versions in env to github.ref_name
      - run: |
          if [ "${{ env.CMAKE_VER }}" != "${{ env.PUB_VER }}" || "${{ env.CMAKE_VER }}" != "${{ github.ref_name }}" || "${{ github.ref_name }}" != "${{ env.PUB_VER }}" ]; then
            echo "Version mismatch: CMakeLists.txt: ${{ env.CMAKE_VER }} != dart/pubspec.yaml: ${{ env.PUB_VER }} != github.ref_name: ${{ github.ref_name }}"
            exit 1
          fi
  compile:
    name: Binary
    needs: version
    strategy:
      matrix:
        dist:
          - os: linux
            arch: x64
            runner: ubuntu-latest
          - dist-os: android
            arch: x86_64
            runner: ubuntu-latest
          - dist-os: android
            arch: armeabi-v7a
            runner: ubuntu-latest
          - dist-os: android
            arch: arm64-v8a
            runner: ubuntu-latest
    runs-on: ${{ matrix.dist.runner }}
    container:
      image: ghcr.io/jeffmur/fhel:builder
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "true"
      - run: make dist-ci ARCH=${{ matrix.dist.arch }} OS=${{ matrix.dist.os }}
        id: dist
      - uses: actions/upload-artifact@v4
        name: upload
        with:
          path: ${{ steps.dist.outputs.tar_gz_path }}
          name: ${{ steps.dist.outputs.tar_gz_name }}

  # dart:
  #   name: pub.dev
  #   needs: version
  #   runs-on: ubuntu-latest
  #   container:
  #     image: ghcr.io/jeffmur/fhel:builder
  #   permissions:
  #     id-token: write # Required for authentication using OIDC
  #   environment:
  #     name: pub.dev
  #     url: https://pub.dev/packages/fhel
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: "true"
  #     - uses: dart-lang/setup-dart@v1
  #     - run: make publish-ci
